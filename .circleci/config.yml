  jobs:
   test:
    docker:
       - image: circleci/openjdk:11.0.4-stretch-node
    working_directory: ~/calva
    steps:
      - checkout:
         path: ~/calva
      - run:
         name: Install node_modules
         command: npm install
      - run:
         name: Install vsce
         command: npm install -g vsce
      - run:
         name: Run Tests
         command: echo Add Test execution
   build:
     docker:
       - image: circleci/openjdk:11.0.4-stretch-node
     branches:
        only:
          - master
     working_directory: ~/calva
     steps:
       - checkout:
          path: ~/calva
       - run:
          name: Install node_modules
          command: npm install
       - run:
          name: Install vsce
          command: npm install -g vsce
       - run:
          name: package vsix
          command: vsce package
       - run:
          name: Copy vsix
          command: |
            mkdir /tmp/artifacts
            cp *.vsix /tmp/artifacts/
       - store_artifacts:
           path: /tmp/artifacts
       - save_cache:
           paths: /tmp/artifacts
           key: calva-{{ .BuildNum }}
   publish:
      docker:
         - image: circleci/openjdk:11.0.4-stretch-node
      branches:
       only:
         - master
      steps:
        - restore_cache:
           name: restoring previous cache
           key: calva-{{ .BuildNum }}
        - run:
           name:
           command: vsce publish --packagePath /tmp/artifacts/*.vsix -p $PUBLISH_TOKEN
 workflows:
  version: 2
  master-build-publish:
    jobs:
      - test:
          filters:  
              branches:
                only:
                  - master
      - build:
          requires: test
      - publish:
          requires: build
          type: approval

